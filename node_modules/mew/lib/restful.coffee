Restful = require 'restler' 
{EventEmitter} = require 'events'

class RestfulClient extends EventEmitter
    constructor : (@cookies) ->

    setUserAgent : (agent)->
        if agent
            @userAgent = agent
        else
            @userAgent = process.env.MEWBOT_UA || "mewbot"

    setCookie : (key,value) ->
        if @cookies is undefined
            @cookies = {}
        @cookies[key]=value

    buildHeader : (url)->
        headers = {}
        if @userAgent
            headers["User-Agent"] = @userAgent
        else
            headers["User-Agent"] = process.env.MEWBOT_UA || "mewbot"

        if url
            headers["Referer"] = url

        headers["Cookie"]= @buildCookies()
        return headers

    getAndRefer : (url,referer,callback)->
        options = headers : @buildHeader(referer)
        promise = Restful.get(url,options)
        promise.on "complete",(data,response)=>
            if response and response.statusCode is 200
                @handleResponseCookie(response)
                callback(null,data,response)
            else
                callback(response.statusCode)
        promise.on "error",(err)=>
            callback(err)

    get : (url,callback)->
        @getAndRefer url,url,callback
        
    buildCookies : ->
        if @cookies is undefined
            @cookies = {}
        cookieString = ""
        for cookieKey,cookieValue of @cookies
            cookieString=cookieString+cookieKey+"="+cookieValue+";"
        return cookieString
     
    login: (loginURL,loginData,callback,error) ->
        queryData = loginData
        headers = Cookie : @getCookies()
        options = data : queryData , headers : headers
        Restful.post(loginURL, options).on 'complete', (data,response) =>
            @handleResponseCookie response
            try
                if callback
                    callback(data)
            catch e
                if error
                    error(e)

    handleResponseCookie : (response) ->
        try
            if @cookies is undefined
                @cookies = {}
            if response and typeof response.headers['set-cookie'] isnt 'undefined'
                for cookie in response.headers['set-cookie']
                    cookieIndex = cookie.indexOf('=')
                    cookieEndIndex = cookie.indexOf(';')
                    cookieName = cookie.substr(0,cookieIndex)
                    cookieValue = ""
                    if cookieEndIndex >= 0 
                        cookieValue = cookie.substr(cookieIndex+1,cookieEndIndex-cookieIndex-1)
                    else
                        cookieValue = cookie.substr(cookieIndex+1)
                    @setCookie(cookieName,cookieValue)
        catch e
            console.log "#{e.stack}"


module.exports=RestfulClient